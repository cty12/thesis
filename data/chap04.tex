\chapter{多虚拟化集群管理系统的设计}
\label{cha:multi-hypervisor-management-system}

通过努力使得 Tsinghua NOVA 系统通过 libvirt 支持了 LXC 虚拟容器，从而从单一的 QEMU-KVM
虚拟集群管理，转变为支持多种虚拟化方案的多虚拟化集群管理系统。而且，管理通过不同的虚拟化技术
运行的虚拟机的用户接口部分是完全相同的，也就是说，用户可以通过一个统一的控制面板 (control
panel) 和相同的操作方式管理由 QEMU-KVM 或是虚拟容器运行的虚拟机。

\section{容器的自动部署}
\label{sec:auto-deployment}

所谓自动部署，无论是对何种虚拟化技术，都是指的从展开客户机需要的操作系统磁盘镜像、到部署客户机的
用户态应用程序、再到连接到管理程序的虚拟机驱动并实现用户对客户机的管理的步骤。在 Tsinghua NOVA
系统中，下层的虚拟化平台对用户来讲是完全透明的。

\subsection{存储方案的比较}
\label{subsec:comparison-network-storage}

既然是一个虚拟化管理平台，那么就需要对虚拟机磁盘镜像或者根文件系统 (rootfs) 进行统一的管理。
在 Tsinghua NOVA 系统中，是由一个主节点 (master node) 提供 web 服务和虚拟机调度服务，
在多个从节点 (slave node) 上部署虚拟集群，所以这个镜像存储服务自然也是将主节点作为服务器、
从节点作为客户端的。

\subsubsection{存储的内容}

首先看一下 QEMU-KVM 的镜像文件和 LXC 的根文件系统 (rootfs) 都具有什么特点。

\subsubsubsection{QEMU 磁盘镜像}

我们在 ~\ref{subsubsec:hardware-virt} 小节提到，QEMU-KVM 模拟设备，比如磁盘设备，
使用的是 QEMU ，因此 QEMU-KVM 支持的磁盘镜像格式就是 QEMU 支持的磁盘镜像格式，主要
包括以下几种：

\begin{itemize}
    \item \textbf{raw:} 简单的二进制镜像，在有的文件系统，比如 xfs 和 ext4 上支持稀疏
    存储的特性，也就是分配的空间会以 metadata 的形式被记录，从而实际占用的空间小于或者等于
    分配的空间；
    \item \textbf{cow:} 简单的写时复制 (copy-on-write) 镜像，这种格式不支持 Windows
    虚拟机；
    \item \textbf{qcow:} QEMU 写时复制 (copy-on-write) 格式，已经被 \textbf{qcow2}
    格式取代了，QEMU 仍然兼容这种格式；
    \item \textbf{qcow2:} 支持快照 (snapshot) 、稀疏存储（即使在不支持上文提到的稀疏
    存储特性的文件系统上也可以实现，不受制于文件系统）、加密、压缩等高级特性的 QEMU 镜像
    格式。这种格式有很好的特性和功能表现，所以是被 Tsinghua NOVA 系统采用用来运行 KVM
    客户虚拟机操作系统的格式；
    \item \textbf{vmdk:} VMWare 的磁盘镜像格式；
    \item \textbf{vdi:} VirtualBox 的磁盘镜像格式；
\end{itemize}

QEMU 对镜像文件的格式支持非常丰富，还有几种不常用的，因为篇幅所限不能一一介绍。Tsinghua NOVA
使用 qcow2 格式，它能通过 QEMU 提供的用户态工具 qemu-img 支持虚拟机增量镜像，从而减少
网络文件系统对镜像存储的负担。因为只要存储一个操作系统的基准镜像，然后每个客户虚拟机创建
自己的增量镜像就可以了。下面简单介绍一下 qemu-img 的常见命令。

创建一个大小为 20GB 、格式为 qcow2 的镜像文件：

\begin{lstlisting}[language=bash]
qemu-img create hello.qcow2 -f qcow2 20G
\end{lstlisting}

查看镜像的详细信息：

\begin{lstlisting}
qemu-img info hello.qcow2
\end{lstlisting}

对镜像进行格式转换，例如把 raw 格式的镜像转为 qcow2 格式的镜像（从而利用 qcow2 格式更好的
特性）：

\begin{lstlisting}[language=bash]
qemu-img convert -p -f raw -O qcow2 hello hello2.qcow2
\end{lstlisting}

加上 -p 参数就可以显示进度。

对镜像进行压缩和加密，不过只有 qcow2 格式的镜像才支持这个功能，例如对刚才创建的镜像：

\begin{lstlisting}[language=bash]
qemu-img convert -c -f qcow2 -O qcow2 hello.qcow2 hello3.qcow2
qemu-img convert -f qcow2 -O qcow2 hello.qcow2 hello4.qcow2 -o encryption
\end{lstlisting}

对镜像进行快照，这也是 qcow2 格式的一个特性。例如创建一个 hello.qcow2 的快照：

\begin{lstlisting}[language=bash]
qemu-img snapshot hello.qcow2 -c snapshot00
\end{lstlisting}

创建差量镜像。之所以要使用镜像差量技术，主要是有两个好处：

\begin{enumerate}
    \item \textbf{节约时间：} 通过一个命令可以立即从基镜像生成虚拟机用到的镜像，非常快；
    \item \textbf{节约空间：} 镜像使用写时复制 (copy-on-write) 的模式，读取的时候读取
    自己的或者是基镜像的镜像文件，写入的时候才写入自己的镜像文件，也就是差量镜像，这样
    多个客户虚拟机用一个基镜像，把它们共同的点统一储存，而且只存一份，可以节约空间。
    尤其是对于 Tsinghua NOVA 这种使用网络文件系统的平台，非常重要。
\end{enumerate}

创建的方法：

\begin{lstlisting}[language=bash]
qemu-img create -f qcow2 -b hello.qcow2 hello-bak
\end{lstlisting}

使用 qemu-img 工具还可以很方便地将差量镜像整合回完整的镜像。

\subsubsubsection{LXC 的根文件系统}

LXC 的根文件系统完全是在宿主的文件系统上创建的一个普通的目录，包含客户机的完整的根文件系统，
默认在 /var/lib/lxc 下。由于 namespace 技术将不同容器使用的磁盘资源做了隔离，所以不同
容器可以挂载各自的根文件系统 (rootfs) 并读写之，不会产生干扰。在宿主机上也可以直接对
这些目录进行修改，例如创建文件。

这样的好处是 LXC 的根文件系统 (rootfs) 具有可移动性 (portability) ，比如可以将一个虚拟
容器的文件系统直接拷贝到新的宿主上直接运行，可以保留原先的所有资料不至于丢失。而且在宿主上
可以直接访问客户机的根文件系统，就像一个普通目录一样，这也是一个非常方便的特性。

LXC 的用户态工具提供了一些处理根文件系统 (rootfs) 的手段，但是较为简单和直接，举例如下：

在 /var/lib/lxc/test-fedora-1/rootfs 里创建一个基于 Fedora 22 的根文件系统，
因为需要联网下载所需文件，所以速度主要取决于网速，当然宿主的磁盘 I/O 也是很重要的：

\begin{lstlisting}
lxc-create -n test-fedora-1 -t fedora
\end{lstlisting}

对根文件系统进行快照。所谓的快照就是把根文件系统 (rootfs) 复制一份保留下来：

\begin{lstlisting}
lxc-snapshot -n test-fedora-1
\end{lstlisting}

还有诸如 lxc-clone 等几个功能，总而言之是非常简单的，不仅相比 QEMU-KVM 的镜像组织
\footnote{qcow2 的镜像差量功能相当于自带了一个简单的去冗余}来说，而且相比 docker
完整的镜像定义、组织和类似 git 的版本管理也逊色很多。但是 LXC 的好处是它的基本功能
都比较简单，而且相应的 libvirt 驱动处于一个基本可用的状态，所以 Tsinghua NOVA
系统还是选取 LXC 而不是 docker 作为 Linux 虚拟容器的解决方案。当然，docker 的
“一揽子”用户态工具是非常非常方便的，类似的基于 web 的图形管理控制面板也有不少。
\footnote{比如：https://shipyard-project.com/}

\subsubsection{几种网络存储方案的选型}
